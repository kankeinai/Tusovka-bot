from dotenv import load_dotenv
from pydantic_settings import BaseSettings
import os
from dataclasses import dataclass
from typing import Dict, Any

# Load environment variables first
load_dotenv()

class Settings:
    BOT_TOKEN: str = os.getenv("BOT_TOKEN", "")
    DATABASE_URL_UNPOOLED: str = os.getenv("DATABASE_URL_UNPOOLED", "")
    OPENAI_API_KEY: str = os.getenv("OPENAI_API_KEY", "")
    ADMINS: list[str] = [
        '658415666',
    ]

    class Config:
        env_file = ".env"
        extra = "ignore"  # This will ignore extra environment variables

# Initialize settings
settings = Settings()

languages = {
    'ru': 'russian',
    'en': 'english',
    'fi': 'finnish',
    'kz': 'kazakh'
}

system_message = """
You are a strict but supportive assistant for Tusovka language school, helping students prepare for the YKI Finnish exam. You always provide clear, concise, and constructive feedback in the student's preferred language. Your evaluations follow YKI criteria closely and highlight exactly what needs to be improved. Be firm, fair, and focused on progress.
YKI score 0 means the response is off-topic, empty, or completely fails to show any usable language skills.
YKI score 1 means the response shows very limited language ability with major errors and unclear communication.
YKI score 2 means the response shows some basic language skills but with frequent errors and limited ability to express clear ideas.s
YKI score 3 means the response is understandable and mostly on-topic, but contains noticeable errors and limited vocabulary.
YKI score 4 means the response is clear and mostly correct, with occasional mistakes but sufficient language skills for everyday situations
YKI score 5 means the response is fluent, well-structured, and mostly accurate, with only minor errors that do not affect understanding.
YKI score 6 means the response is very fluent, precise, and nearly error-free, demonstrating excellent control of language and style.
"""


tests = {
    'writing_part_1': """
        Generate me topic for writing part 1 test of Finnish YKI (Ep√§muodollinen viesti ‚Äî –ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ). 
        Provide all instructions that are usually present on the test. Do not include any other text.
        Topic should be in Finnish. 
        Example: write a message to a friend, neighbor, colleague.
        Typical topics: invite, tell about an event, explain a situation.
        Volume: 50‚Äì100 words.
    """,
    'writing_part_2': """
        Generate me topic for writing part 2 test of Finnish YKI (Muodollinen viesti ‚Äî –§–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ). 
        Provide all instructions that are usually present on the test.
        Topic should be in Finnish.
        Example: complaint, request, message to an official institution (hospital, school, store).
        Typical topics: cancel a meeting, complaint about a service, request information.
        Volume: 100‚Äì150 words.
    """,
    'writing_part_3': """
        Generate me topic for writing part 3 test of Finnish YKI (Mielipideteksti ‚Äî –í—ã—Ä–∞–∂–µ–Ω–∏–µ –º–Ω–µ–Ω–∏—è). 
        Provide all instructions that are usually present on the test.
        Topic should be in Finnish.
        example: You need to express and justify your opinion on the proposed topic.
        Example topic: "Is it important to practice sports?"
        Volume: 150‚Äì200 words.
    """
}

writing_parts_names ={
    'writing_part_1': "Ep√§muodollinen viesti",
    'writing_part_2': "Muodollinen viesti",
    'writing_part_3': "Mielipideteksti",
}

# Test time limits in minutes
test_time_limits = {
    'writing_part_1': 15,  
    'writing_part_2': 20,  
    'writing_part_3': 25,     
}

def get_test_time_limit(test_type: str) -> int:
    """Get time limit in minutes for a specific test type."""
    return test_time_limits.get(test_type, 30)  # Default 30 minutes

# Language translations
TRANSLATIONS = {
    'ru': {
        'welcome': 'üëã –ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ YKI!\n\nüìù –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /test –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏\n‚öôÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫',
        'not_registered': '‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
        'menu_title': '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        'change_name': '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è',
        'change_language': 'üåç –ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫',
        'change_level': 'üìä –ò–∑–º–µ–Ω–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å',
        'back': '‚¨ÖÔ∏è –ù–∞–∑–∞–¥',
        'choose_language': 'üåç –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:',
        'choose_level': 'üìä –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å:',
        'level_changed': '‚úÖ –£—Ä–æ–≤–µ–Ω—å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {level}!',
        'already_in_test': '‚ö†Ô∏è –í—ã —É–∂–µ –≤ —Ç–µ—Å—Ç–µ\n\n–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Ç–µ—Å—Ç —Å–Ω–∞—á–∞–ª–∞',
        'choose_part': 'üìù –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è:',
        'generating_topic': 'üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ç–µ–º—É –¥–ª—è {topic}...',
        'test_time_limit': '‚è∞ –£ –≤–∞—Å {minutes} –º–∏–Ω—É—Ç –Ω–∞ –æ—Ç–≤–µ—Ç',
        'test_title': 'üìù **{title} - YKI Test**\n\n{topic}',
        'test_creation_error': '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–∞\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
        'response_saved': '‚úÖ –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\n\n–ú–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏',
        'test_not_found': '‚ùå –¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω\n\n–ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ',
        'test_cancelled': '‚ùå –¢–µ—Å—Ç –æ—Ç–º–µ–Ω–µ–Ω',
        'generating_grade': 'üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ü–µ–Ω–∫—É...',
        'grade_title': 'üìä –û—Ü–µ–Ω–∫–∞: {grade}',
        'grade_reason_not_finnish': '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞ —Ñ–∏–Ω—Å–∫–æ–º —è–∑—ã–∫–µ',
        'grade_reason_off_topic': '–¢–µ–∫—Å—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ',
        'grade_reason_rejected': '–¢–µ–∫—Å—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω',
        'grade_reason_grade_extraction_failed': '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –æ—Ü–µ–Ω–∫—É',
        'grade_reason_error_occurred': '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ',
        'grade_zero_message': '–í—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ü–µ–Ω–∫—É 0. –ü—Ä–∏—á–∏–Ω–∞: {reason}',
        'generating_feedback': 'üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...',
        'feedback_title': 'üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**\n\n{feedback}',
        'generating_advice': 'üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–æ–≤–µ—Ç—ã...',
        'advice_title': 'üéØ **–ß—Ç–æ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å:**\n\n{advice}',
        'grade_error': '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ü–µ–Ω–∫–∏\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
        'feedback_error': '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
        'advice_error': '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–æ–≤\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
        'test_not_found_error': '‚ùå –¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω',
        'time_expired': '‚è∞ –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ!',
        'no_response_provided': '‚è∞ –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ!\n\n–û—Ç–≤–µ—Ç –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω',
        'what_is_my_score': 'üìä –ö–∞–∫–∞—è –º–æ—è –æ—Ü–µ–Ω–∫–∞?',
        'how_can_i_improve': 'üí° –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å—Å—è?',
        'what_do_i_need_to_practice': 'üéØ –ß—Ç–æ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å?',
        'confirm_registration': '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é',
        'invite_code_prompt': 'üîë –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:',
        'invalid_invite': '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑',
        'registration_success': '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞',
        'name_prompt': '‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:',
        'name_updated': '‚úÖ –ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!',
        'language_updated': '‚úÖ –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω!',
        'unknown_message': 'üëã –ü—Ä–∏–≤–µ—Ç!',
        'warning_5min': '‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ!**\n\n–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å 5 –º–∏–Ω—É—Ç!',
        'warning_1min': 'üö® **–°—Ä–æ—á–Ω–æ!**\n\n–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å 1 –º–∏–Ω—É—Ç–∞!',
        'warning_generic': '‚è∞ –î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å {minutes} –º–∏–Ω—É—Ç!',
        'grade_title' : 'üìä **Grade:**\n\n{grade}',
    },
    'en': {
        'welcome': 'üëã Hi! Welcome to the YKI preparation bot!\n\nüìù Use /test to start preparing\n‚öôÔ∏è Use /menu for settings',
        'not_registered': '‚ùå You are not registered\n\nUse /start to register',
        'menu_title': '‚öôÔ∏è Settings',
        'change_name': '‚úèÔ∏è Change name',
        'change_language': 'üåç Change language',
        'change_level': 'üìä Change level',
        'back': '‚¨ÖÔ∏è Back',
        'choose_language': 'üåç Choose language:',
        'choose_level': 'üìä Choose level:',
        'level_changed': '‚úÖ Level changed to {level}!',
        'already_in_test': '‚ö†Ô∏è You are already in a test\n\nPlease finish the current test first',
        'choose_part': 'üìù Choose a part to write:',
        'generating_topic': 'üîÑ Generating topic for {topic}...',
        'test_time_limit': '‚è∞ You have {minutes} minutes to respond',
        'test_title': 'üìù **{title} - YKI Test**\n\n{topic}',
        'test_creation_error': '‚ùå Error creating test\n\nTry again later',
        'response_saved': '‚úÖ Response saved!\n\nYou can send a new response or wait for time to expire',
        'test_not_found': '‚ùå Test not found\n\nStart over',
        'test_cancelled': '‚ùå Test cancelled',
        'generating_grade': 'üîÑ Generating grade...',
        'grade_title': 'üìä Grade: {grade}',
        'grade_reason_not_finnish': 'Text is not in Finnish',
        'grade_reason_off_topic': 'Text is off-topic',
        'grade_reason_rejected': 'Text was rejected',
        'grade_reason_grade_extraction_failed': 'Could not extract grade',
        'grade_reason_error_occurred': 'An error occurred during grading',
        'grade_zero_message': 'You received a score of 0. Reason: {reason}',
        'generating_feedback': 'üîÑ Generating feedback...',
        'feedback_title': 'üí° **Feedback:**\n\n{feedback}',
        'generating_advice': 'üîÑ Generating advice...',
        'advice_title': 'üéØ **What to practice:**\n\n{advice}',
        'grade_error': '‚ùå Error generating grade\n\nTry again later',
        'feedback_error': '‚ùå Error generating feedback\n\nTry again later',
        'advice_error': '‚ùå Error generating advice\n\nTry again later',
        'test_not_found_error': '‚ùå Test not found',
        'time_expired': '‚è∞ Time expired!',
        'no_response_provided': '‚è∞ Time expired!\n\nNo response was provided',
        'what_is_my_score': 'üìä What is my score?',
        'how_can_i_improve': 'üí° How can I improve?',
        'what_do_i_need_to_practice': 'üéØ What do I need to practice?',
        'confirm_registration': '‚úÖ Confirm registration',
        'invite_code_prompt': 'üîë Enter invite code:',
        'invalid_invite': '‚ùå Invalid invite code\n\nTry again',
        'registration_success': '‚úÖ Registration successful!\n\nYou can now use the bot',
        'name_prompt': '‚úèÔ∏è Enter your name:',
        'name_updated': '‚úÖ Name updated!',
        'language_updated': '‚úÖ Language changed!',
        'unknown_message': 'üëã Hi!',
        'warning_5min': '‚ö†Ô∏è **Warning!**\n\n5 minutes left until test ends!',
        'warning_1min': 'üö® **Urgent!**\n\n1 minute left until test ends!',
        'warning_generic': '‚è∞ {minutes} minutes left until test ends!',
        'grade_title' : 'üìä **Grade:**\n\n{grade}',
    },
    'fi': {
        'welcome': 'üëã Hei! Tervetuloa YKI-valmennusbottiin!\n\nüìù K√§yt√§ /test aloittaaksesi valmennuksen\n‚öôÔ∏è K√§yt√§ /menu asetusten muuttamiseen',
        'not_registered': '‚ùå Et ole rekister√∂itynyt\n\nK√§yt√§ /start rekister√∂itymiseen',
        'menu_title': '‚öôÔ∏è Asetukset',
        'change_name': '‚úèÔ∏è Muuta nime√§',
        'change_language': 'üåç Muuta kielt√§',
        'change_level': 'üìä Muuta tasoa',
        'back': '‚¨ÖÔ∏è Takaisin',
        'choose_language': 'üåç Valitse kieli:',
        'choose_level': 'üìä Valitse taso:',
        'level_changed': '‚úÖ Taso muutettu {level}!',
        'already_in_test': '‚ö†Ô∏è Olet jo testiss√§\n\nLopeta nykyinen testi ensin',
        'choose_part': 'üìù Valitse kirjoitettava osa:',
        'generating_topic': 'üîÑ Generoin aihetta {topic}...',
        'test_time_limit': '‚è∞ Sinulla on {minutes} minuuttia vastata',
        'test_title': 'üìù **{title} - YKI Testi**\n\n{topic}',
        'test_creation_error': '‚ùå Virhe testin luomisessa\n\nYrit√§ my√∂hemmin',
        'response_saved': '‚úÖ Vastaus tallennettu!\n\nVoit l√§hett√§√§ uuden vastauksen tai odottaa ajan umpeutumista',
        'test_not_found': '‚ùå Testi√§ ei l√∂ytynyt\n\nAloita uudelleen',
        'test_cancelled': '‚ùå Testi peruttu',
        'generating_grade': 'üîÑ Generoin arvosanaa...',
        'grade_title': 'üìä Arvosana: {grade}',
        'grade_reason_not_finnish': 'Teksti ei ole suomeksi',
        'grade_reason_off_topic': 'Teksti ei liity aiheeseen',
        'grade_reason_rejected': 'Teksti hyl√§ttiin',
        'grade_reason_grade_extraction_failed': 'Arvosanaa ei voitu poimia',
        'grade_reason_error_occurred': 'Arvioinnissa tapahtui virhe',
        'grade_zero_message': 'Sait arvosanan 0. Syy: {reason}',
        'generating_feedback': 'üîÑ Generoin palautetta...',
        'feedback_title': 'üí° **Palautetta:**\n\n{feedback}',
        'generating_advice': 'üîÑ Generoin neuvoja...',
        'advice_title': 'üéØ **Mit√§ harjoitella:**\n\n{advice}',
        'grade_error': '‚ùå Virhe arvosanan generoinnissa\n\nYrit√§ my√∂hemmin',
        'feedback_error': '‚ùå Virhe palautteen generoinnissa\n\nYrit√§ my√∂hemmin',
        'advice_error': '‚ùå Virhe neuvojen generoinnissa\n\nYrit√§ my√∂hemmin',
        'test_not_found_error': '‚ùå Testi√§ ei l√∂ytynyt',
        'time_expired': '‚è∞ Aika umpeutui!',
        'no_response_provided': '‚è∞ Aika umpeutui!\n\nVastausta ei annettu',
        'what_is_my_score': 'üìä Mik√§ on arvosanani?',
        'how_can_i_improve': 'üí° Miten voin parantaa?',
        'what_do_i_need_to_practice': 'üéØ Mit√§ minun pit√§√§ harjoitella?',
        'confirm_registration': '‚úÖ Vahvista rekister√∂ityminen',
        'invite_code_prompt': 'üîë Sy√∂t√§ kutsumiskoodi:',
        'invalid_invite': '‚ùå Virheellinen kutsumiskoodi\n\nYrit√§ uudelleen',
        'registration_success': '‚úÖ Rekister√∂ityminen onnistui!\n\nNyt voit k√§ytt√§√§ bottia',
        'name_prompt': '‚úèÔ∏è Sy√∂t√§ nimesi:',
        'name_updated': '‚úÖ Nimi p√§ivitetty!',
        'language_updated': '‚úÖ Kieli muutettu!',
        'unknown_message': 'üëã Hei!',
        'warning_5min': '‚ö†Ô∏è **Varoitus!**\n\n5 minuuttia j√§ljell√§ testin loppuun!',
        'warning_1min': 'üö® **Kiireellinen!**\n\n1 minuutti j√§ljell√§ testin loppuun!',
        'warning_generic': '‚è∞ {minutes} minuuttia j√§ljell√§ testin loppuun!',
        'grade_title' : 'üìä **Grade:**\n\n{grade}',
    },
    'kz': {
        'welcome': 'üëã –°”ô–ª–µ–º! YKI –¥–∞–π—ã–Ω–¥—ã“õ –±–æ—Ç—ã–Ω–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!\n\nüìù /test –∞—Ä“õ—ã–ª—ã –¥–∞–π—ã–Ω–¥—ã“õ—Ç—ã –±–∞—Å—Ç–∞“£—ã–∑\n‚öôÔ∏è /menu –∞—Ä“õ—ã–ª—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä–¥—ñ ”©–∑–≥–µ—Ä—Ç—ñ“£—ñ–∑',
        'not_registered': '‚ùå –°—ñ–∑ —Ç—ñ—Ä–∫–µ–ª–º–µ–≥–µ–Ω—Å—ñ–∑\n\n–¢—ñ—Ä–∫–µ–ª—É “Ø—à—ñ–Ω /start –ø–∞–π–¥–∞–ª–∞–Ω—ã“£—ã–∑',
        'menu_title': '‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä',
        'change_name': '‚úèÔ∏è –ê—Ç—ã–Ω ”©–∑–≥–µ—Ä—Ç—É',
        'change_language': 'üåç –¢—ñ–ª–¥—ñ ”©–∑–≥–µ—Ä—Ç—É',
        'change_level': 'üìä –î–µ“£–≥–µ–π–¥—ñ ”©–∑–≥–µ—Ä—Ç—É',
        'back': '‚¨ÖÔ∏è –ê—Ä—Ç“õ–∞',
        'choose_language': 'üåç –¢—ñ–ª–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:',
        'choose_level': 'üìä –î–µ“£–≥–µ–π–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:',
        'level_changed': '‚úÖ –î–µ“£–≥–µ–π {level} –±–æ–ª—ã–ø ”©–∑–≥–µ—Ä—Ç—ñ–ª–¥—ñ!',
        'already_in_test': '‚ö†Ô∏è –°—ñ–∑ “õ–∞–∑—ñ—Ä–¥—ñ“£ ”©–∑—ñ–Ω–¥–µ —Å—ã–Ω–∞“õ—Ç–∞—Å—ã–∑\n\n–ê–ª–¥—ã–º–µ–Ω –∞“ì—ã–º–¥–∞“ì—ã —Å—ã–Ω–∞“õ—Ç—ã –∞—è“õ—Ç–∞“£—ã–∑',
        'choose_part': 'üìù –ñ–∞–∑—É “Ø—à—ñ–Ω –±”©–ª—ñ–º–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:',
        'generating_topic': 'üîÑ {topic} —Ç–∞“õ—ã—Ä—ã–±—ã–Ω –∂–∞—Å–∞—É–¥–∞...',
        'test_time_limit': '‚è∞ –ñ–∞—É–∞–ø –±–µ—Ä—É–≥–µ {minutes} –º–∏–Ω—É—Ç —É–∞“õ—ã—Ç—ã“£—ã–∑ –±–∞—Ä',
        'test_title': 'üìù **{title} - YKI –°—ã–Ω–∞“ì—ã**\n\n{topic}',
        'test_creation_error': '‚ùå –°—ã–Ω–∞“õ –∂–∞—Å–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ\n\n–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑',
        'response_saved': '‚úÖ –ñ–∞—É–∞–ø —Å–∞“õ—Ç–∞–ª–¥—ã!\n\n–ñ–∞“£–∞ –∂–∞—É–∞–ø –∂—ñ–±–µ—Ä–µ –∞–ª–∞—Å—ã–∑ –Ω–µ–º–µ—Å–µ —É–∞“õ—ã—Ç—Ç—ã“£ ”©—Ç—É—ñ–Ω –∫“Ø—Ç–µ –∞–ª–∞—Å—ã–∑',
        'test_not_found': '‚ùå –°—ã–Ω–∞“õ —Ç–∞–±—ã–ª–º–∞–¥—ã\n\n“ö–∞–π—Ç–∞ –±–∞—Å—Ç–∞“£—ã–∑',
        'test_cancelled': '‚ùå –°—ã–Ω–∞“õ —Ç–æ“õ—Ç–∞—Ç—ã–ª–¥—ã',
        'generating_grade': 'üîÑ –ë–∞“ì–∞ –∂–∞—Å–∞—É–¥–∞...',
        'grade_title': 'üìä –ë–∞“ì–∞: {grade}',
        'grade_reason_not_finnish': '–ú”ô—Ç—ñ–Ω —Ñ–∏–Ω —Ç—ñ–ª—ñ–Ω–¥–µ –µ–º–µ—Å',
        'grade_reason_off_topic': '–ú”ô—Ç—ñ–Ω —Ç–∞“õ—ã—Ä—ã–ø“õ–∞ —Å”ô–π–∫–µ—Å –µ–º–µ—Å',
        'grade_reason_rejected': '–ú”ô—Ç—ñ–Ω “õ–∞–±—ã–ª–¥–∞–Ω–±–∞–¥—ã',
        'grade_reason_grade_extraction_failed': '–ë–∞“ì–∞–Ω—ã —à—ã“ì–∞—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å',
        'grade_reason_error_occurred': '–ë–∞“ì–∞–ª–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã',
        'grade_zero_message': '–°—ñ–∑ 0 –±–∞“ì–∞ –∞–ª–¥—ã“£—ã–∑. –°–µ–±–µ–±—ñ: {reason}',
        'generating_feedback': 'üîÑ –ö–µ“£–µ—Å –∂–∞—Å–∞—É–¥–∞...',
        'feedback_title': 'üí° **–ö–µ“£–µ—Å—Ç–µ—Ä:**\n\n{feedback}',
        'generating_advice': 'üîÑ –ö–µ“£–µ—Å –∂–∞—Å–∞—É–¥–∞...',
        'advice_title': 'üéØ **–ù–µ –∂–∞—Ç—Ç—ã“ì—É –∫–µ—Ä–µ–∫:**\n\n{advice}',
        'grade_error': '‚ùå –ë–∞“ì–∞ –∂–∞—Å–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ\n\n–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑',
        'feedback_error': '‚ùå –ö–µ“£–µ—Å –∂–∞—Å–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ\n\n–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑',
        'advice_error': '‚ùå –ö–µ“£–µ—Å –∂–∞—Å–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ\n\n–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑',
        'test_not_found_error': '‚ùå –°—ã–Ω–∞“õ —Ç–∞–±—ã–ª–º–∞–¥—ã',
        'time_expired': '‚è∞ –£–∞“õ—ã—Ç ”©—Ç—Ç—ñ!',
        'no_response_provided': '‚è∞ –£–∞“õ—ã—Ç ”©—Ç—Ç—ñ!\n\n–ñ–∞—É–∞–ø –±–µ—Ä—ñ–ª–º–µ–¥—ñ',
        'what_is_my_score': 'üìä –ú–µ–Ω—ñ“£ –±–∞“ì–∞–º “õ–∞–Ω–¥–∞–π?',
        'how_can_i_improve': 'üí° “ö–∞–ª–∞–π –∂–∞“õ—Å–∞—Ä—Ç–∞ –∞–ª–∞–º—ã–Ω?',
        'what_do_i_need_to_practice': 'üéØ –ù–µ –∂–∞—Ç—Ç—ã“ì—É –∫–µ—Ä–µ–∫?',
        'confirm_registration': '‚úÖ –¢—ñ—Ä–∫–µ—É–¥—ñ —Ä–∞—Å—Ç–∞—É',
        'invite_code_prompt': 'üîë –®–∞“õ—ã—Ä—É –∫–æ–¥—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:',
        'invalid_invite': '‚ùå “ö–∞—Ç–µ —à–∞“õ—ã—Ä—É –∫–æ–¥—ã\n\n“ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑',
        'registration_success': '‚úÖ –¢—ñ—Ä–∫–µ—É —Å”ô—Ç—Ç—ñ!\n\n–ï–Ω–¥—ñ –±–æ—Ç—Ç—ã –ø–∞–π–¥–∞–ª–∞–Ω–∞ –∞–ª–∞—Å—ã–∑',
        'name_prompt': '‚úèÔ∏è –ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:',
        'name_updated': '‚úÖ –ê—Ç –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã!',
        'language_updated': '‚úÖ –¢—ñ–ª ”©–∑–≥–µ—Ä—Ç—ñ–ª–¥—ñ!',
        'unknown_message': 'üëã –°”ô–ª–µ–º!',
        'warning_5min': '‚ö†Ô∏è **–ù–∞–∑–∞—Ä –∞—É–¥–∞—Ä—ã“£—ã–∑!**\n\n–°—ã–Ω–∞“õ—Ç—ã“£ –∞—è“õ—Ç–∞–ª—É—ã–Ω–∞ 5 –º–∏–Ω—É—Ç “õ–∞–ª–¥—ã!',
        'warning_1min': 'üö® **–®“±“ì—ã–ª!**\n\n–°—ã–Ω–∞“õ—Ç—ã“£ –∞—è“õ—Ç–∞–ª—É—ã–Ω–∞ 1 –º–∏–Ω—É—Ç “õ–∞–ª–¥—ã!',
        'warning_generic': '‚è∞ –°—ã–Ω–∞“õ—Ç—ã“£ –∞—è“õ—Ç–∞–ª—É—ã–Ω–∞ {minutes} –º–∏–Ω—É—Ç “õ–∞–ª–¥—ã!',
    }
}

def get_text(key: str, language: str = 'ru', **kwargs) -> str:
    """
    Get translated text for the given key and language.
    
    Args:
        key: Translation key
        language: Language code (ru, en, fi, kz)
        **kwargs: Format parameters for the text
        
    Returns:
        Translated text
    """
    if language not in TRANSLATIONS:
        language = 'ru'  # Default to Russian
    
    text = TRANSLATIONS[language].get(key, TRANSLATIONS['ru'].get(key, key))
    
    if kwargs:
        try:
            return text.format(**kwargs)
        except (KeyError, ValueError):
            return text
    
    return text